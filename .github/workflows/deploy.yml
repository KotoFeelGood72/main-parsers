name: Deploy to Server

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install sshpass
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass

      - name: Setup SSH known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Copy files to server
        run: |
          sshpass -p '${{ secrets.SERVER_PASSWORD }}' \
            rsync -avz --exclude 'node_modules' --exclude '.git' --exclude 'logs' --exclude 'assets' \
              -e "ssh -o StrictHostKeyChecking=no" \
              ./ root@${{ secrets.SERVER_HOST }}:/opt/main-parsers/

      - name: Deploy on server
        run: |
          sshpass -p '${{ secrets.SERVER_PASSWORD }}' ssh -o StrictHostKeyChecking=no root@${{ secrets.SERVER_HOST }} bash -c '
            set -e
            mkdir -p /opt/main-parsers
            cd /opt/main-parsers
            
            # Останавливаем и удаляем старые контейнеры (принудительно)
            echo "=== Stopping and removing old containers ==="
            docker-compose down --remove-orphans || true
            
            # Удаляем контейнеры по имени, если они все еще существуют
            docker rm -f car_parser auto_db 2>/dev/null || true
            
            # Удаляем старые образы парсера
            echo "=== Removing old parser images ==="
            docker images | grep "main-parsers.*parser" | awk "{print \$3}" | xargs -r docker rmi -f || true
            
            # Пересобираем образы
            echo "=== Building new images ==="
            docker-compose build --no-cache
            
            # Запускаем контейнеры с автоматическим перезапуском
            echo "=== Starting containers ==="
            docker-compose up -d
            
            # Ждем немного для запуска
            sleep 5
            
            # Проверяем статус контейнеров
            echo "=== Container Status ==="
            docker-compose ps
            
            # Проверяем логи парсера
            echo "=== Parser Logs (last 20 lines) ==="
            docker-compose logs --tail=20 parser || true
            
            # Очищаем неиспользуемые образы
            docker system prune -f
            
            # Проверяем, что контейнеры запущены
            if ! docker-compose ps | grep -q "Up"; then
              echo "ERROR: Some containers are not running!"
              docker-compose ps
              exit 1
            fi
          '
